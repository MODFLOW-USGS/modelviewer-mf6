name: build

on:
  push:
    branches:
      - main
      - main-cmake

env:
  # vtk version
  VTK_VERSION: 6.0.0

  # releases api
  RELEASES_URL: ${{github.api_url}}/repos/${{github.repository}}/releases

jobs:
  build:
    runs-on: windows-2019

    steps:

    - name: Checkout
      uses: actions/checkout@v2

    - name: Cache vtk
      id: cache-vtk
      uses: actions/cache@v2
      with:
        path: |
          C:\VTK6.0.0
          C:\VTK6.0.0_build64
        key: ${{runner.os}}-vtk-${{env.VTK_VERSION}}

    - name: Download and install vtk
      if: steps.cache-vtk.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        pip install gdown
        gdown https://drive.google.com/uc?id=1FHn0dSghDXuVt3OvxrxtJP4KYtLap9be
        7z x -oC:\ vtk6.zip
        Remove-Item vtk6.zip

    - name: Install htmlhelp
      run: |
        curl -L -O http://web.archive.org/web/20160201063255/http://download.microsoft.com/download/0/A/9/0A939EF6-E31C-430F-A3DF-DFAE7960D564/htmlhelp.exe
        cmd /c start /wait .\htmlhelp.exe /q /c /t:$(Get-Location)\tmp
        # These changes allow htmlhelp to be installed without user input
        $file = "$(Get-Location)\tmp\htmlhelp.inf"
        (Get-Content $file) | Foreach-Object { $_ `
          -replace '^BeginPrompt',                                               ';;BeginPrompt' `
          -replace '^EndPrompt',                                                 ';;EndPrompt' `
          -replace '^49000=CustomLDID49000, 1',                                  '49000=CustomLDID49000, 5' `
          -replace '^"hhupd.exe',                                                ';;hhupd.exe' `
          -replace '^DefaultInstallDir="C:\\Program Files\\HTML Help Workshop"', 'DefaultInstallDir="%ProgramFiles%\\HTML Help Workshop"'
        } | Set-Content $file
        cmd /c start /wait .\tmp\setup.exe
        Remove-Item -Recurse -Force .\tmp
        Remove-Item -Recurse -Force .\htmlhelp.exe
        # the next line doesn't seem to work (supposed to set the path)
        # echo 'C:\Program Files (x86)\HTML Help Workshop' >> $GITHUB_PATH

    - name: Compile chm
      shell: bash
      run: |
        pushd Help
        # hhc returns 1 on success
        set +e
        'C:\Program Files (x86)\HTML Help Workshop\hhc' mvmf6.hhp | tee mvmf6.out
        status=${PIPESTATUS[0]}
        set -e
        if [ "$status" -eq 1 ]; then
          echo "[OK]"
          exit 0
        else
          echo "[FAILED]"
          exit 1
        fi
        popd

    - name: Export next mvmf6 version
      run: |
        # create headers dictionary
        $h = @{"Authorization" = "token ${{secrets.GITHUB_TOKEN}}"}

        try {
            $response = Invoke-WebRequest -Uri ${{env.RELEASES_URL}}/latest -Headers $h -Method GET
            $json = $response.Content | ConvertFrom-Json
            $tag_name = $json.tag_name
        }
        catch {
            # none so far
            $tag_name = "0.0"
        }

        $next_version = "0.0.0"
        if ($tag_name -match '(?<major>0|[1-9]\d*)\.(?<minor>0|[1-9]\d*)(?:\.(?<patch>0|[1-9]\d*))?$') {
            if ($Matches.ContainsKey('patch')) {
              $patch = 1 + $Matches['patch']
            }
            else {
              $patch = 0
            }
            $next_version = $Matches['major'] + "." + $Matches['minor'] + "." + $patch
        }
        Write-Output "NEXT_VERSION=$next_version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    # - name: Configure vs2017
    #   shell: pwsh
    #   run: cmake --preset vs2017

    # - name: Build vs2017
    #   shell: pwsh
    #   run: cmake --build _vs2017 --config release

    # - name: Install vs2017
    #   shell: pwsh
    #   run: cmake --install _vs2017 --prefix mvmf6-vs2017-${{env.NEXT_VERSION}} --config release

    # - name: Build mvmf6-vs2017-x.x.x.zip
    #   run: |
    #     Copy-Item .\Help\mvmf6.chm mvmf6-vs2017-${{env.NEXT_VERSION}}\bin\.
    #     7z a -tzip mvmf6-vs2017-${{env.NEXT_VERSION}}.zip .\mvmf6-vs2017-${{env.NEXT_VERSION}}\

    - name: Build mvmf6-vs2017-x.x.x.zip
      run: |
        # Testing multiple asset upload (only htmlhelp file)
        mkdir mvmf6-vs2017-${{env.NEXT_VERSION}}
        mkdir mvmf6-vs2017-${{env.NEXT_VERSION}}\bin
        Copy-Item .\Help\mvmf6.chm mvmf6-vs2017-${{env.NEXT_VERSION}}\bin\.
        7z a -tzip mvmf6-vs2017-${{env.NEXT_VERSION}}.zip .\mvmf6-vs2017-${{env.NEXT_VERSION}}\

    - name: Configure vs2019
      shell: pwsh
      run: cmake --preset vs2019

    - name: Build vs2019
      shell: pwsh
      run: cmake --build _vs2019 --config release

    - name: Install vs2019
      shell: pwsh
      run: cmake --install _vs2019 --prefix mvmf6-vs2019-${{env.NEXT_VERSION}} --config release

    - name: Build mvmf6-vs2019-x.x.x.zip
      run: |
        Copy-Item .\Help\mvmf6.chm mvmf6-vs2019-${{env.NEXT_VERSION}}\bin\.
        7z a -tzip mvmf6-vs2019-${{env.NEXT_VERSION}}.zip .\mvmf6-vs2019-${{env.NEXT_VERSION}}\

    - name: Create release
      run: |
        # store new commit
        $target_commitish = (git log -n1 --format=format:"%H")

        if (! ($env:NEXT_VERSION -match "^(?<major>0|[1-9]\d*)\.(?<minor>[0|1-9]\d*)\.(?<patch>[0|1-9]\d*)$") ) {
          throw "Bad version"
        }
        $version = $env:NEXT_VERSION

        # create headers dictionary
        $h = @{"Authorization" = "token ${{secrets.GITHUB_TOKEN}}"}

        $releases_url = "${{env.releases_url}}"

        # create release
        # POST /repos/{owner}/{repo}/releases
        # see https://docs.github.com/en/rest/reference/repos#create-a-release
        #
        $create = @{
          "tag_name"         = "$env:NEXT_VERSION"
          "target_commitish" = "$target_commitish"
          "name"             = "Model Viewer for Modflow 6 Version " + $version
          "name"             = "Model Viewer for Modflow 6 Version " + $version
          "draft"            = $true
          # "prerelease"       = $true
        }
        $create_json = $create | ConvertTo-Json
        $release = Invoke-WebRequest -Uri $releases_url -Headers $h -Method POST -Body $create_json

        # upload artifact (asset)
        # POST /repos/{owner}/{repo}/releases/{release_id}/assets
        # see https://docs.github.com/en/rest/reference/repos#upload-a-release-asset
        #
        $upload_uri = ($release.Content | ConvertFrom-Json).upload_url
        if (! ($upload_uri -match  "(.*)\{\?name,label\}") ) {
          # expecting URI{?name,label}
          # ie https://uploads.github.com/repos/MODFLOW-USGS/modelviewer-mf6/releases/24058628/assets{?name,label}
          throw "Bad upload_url"
        }

        # vs2017
        $upload_uri = $Matches[1] + "?name=mvmf6-vs2017-$version.zip"
        $h["Content-type"] = "application/zip"
        $bytes = [System.IO.File]::ReadAllBytes("mvmf6-vs2017-$version.zip")
        $upload = Invoke-WebRequest -Uri $upload_uri -Headers $h -Method POST -Body $bytes

        # vs2019
        $upload_uri = $Matches[1] + "?name=mvmf6-vs2019-$version.zip"
        $h["Content-type"] = "application/zip"
        $bytes = [System.IO.File]::ReadAllBytes("mvmf6-vs2019-$version.zip")
        $upload = Invoke-WebRequest -Uri $upload_uri -Headers $h -Method POST -Body $bytes

        # update release
        # PATCH /repos/{owner}/{repo}/releases/{release_id}
        # see https://docs.github.com/en/rest/reference/repos#update-a-release
        #
        $release_id = ($release.Content | ConvertFrom-Json).id
        $h.Remove("Content-type")
        $update = @{ "draft" = $false }
        $update_json = $update | ConvertTo-Json
        $release = Invoke-WebRequest -Uri "$releases_url/$release_id" -Headers $h -Method PATCH -Body $update_json

        # display download url vs2017
        Write-Output "$((($release.Content | ConvertFrom-Json).assets[0]).browser_download_url)"
        Get-FileHash "mvmf6-vs2017-$version.zip"
        Remove-Item mvmf6-vs2017-$version.zip

        # display download url vs2019
        Write-Output "$((($release.Content | ConvertFrom-Json).assets[1]).browser_download_url)"
        Get-FileHash "mvmf6-vs2019-$version.zip"
        Remove-Item mvmf6-vs2019-$version.zip

