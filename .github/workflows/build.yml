name: build

on:
  push:

env:
  # vtk version
  VTK_VERSION: 6.0.0


jobs:
  build:
    runs-on: windows-latest

    steps:

    - name: Checkout
      uses: actions/checkout@v2

    - name: Cache vtk
      id: cache-vtk
      uses: actions/cache@v2
      with:
        path: |
          C:\VTK6.0.0
          C:\VTK6.0.0_build64
        key: ${{runner.os}}-vtk-${{env.VTK_VERSION}}

    - name: Download and install vtk
      if: steps.cache-vtk.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        pip install gdown
        gdown https://drive.google.com/uc?id=1FHn0dSghDXuVt3OvxrxtJP4KYtLap9be
        7z x -oC:\ vtk6.zip
        Remove-Item vtk6.zip

    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v1.1
      with:
        msbuild-architecture: x64
        vs-version: '[16.9,17)'

    - name: Build modelviewer
      run: msbuild MvProject.sln -property:Platform=x64 -property:Configuration=Release

    - name: Build mvmf6.zip
      run: |
        mkdir mvmf6
        Push-Location mvmf6
        Copy-Item ..\ModelViewer\x64\Release\mvmf6.exe .
        Copy-Item ..\mv\x64\Release\mv.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkalglib-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkCommonComputationalGeometry-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkCommonCore-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkCommonDataModel-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkCommonExecutionModel-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkCommonMath-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkCommonMisc-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkCommonSystem-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkCommonTransforms-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkDICOMParser-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkexpat-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkFiltersCore-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkFiltersExtraction-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkFiltersGeneral-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkFiltersGeometry-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkFiltersModeling-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkFiltersSources-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkFiltersStatistics-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkfreetype-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkftgl-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkImagingCore-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkImagingFourier-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkImagingHybrid-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkInteractionStyle-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkIOCore-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkIOImage-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkIOXMLParser-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkjpeg-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkmetaio-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkpng-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkRenderingCore-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkRenderingFreeType-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkRenderingFreeTypeOpenGL-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkRenderingLOD-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkRenderingOpenGL-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtksys-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtktiff-6.0.dll .
        Copy-Item C:\VTK6.0.0_build64\bin\Release\vtkzlib-6.0.dll .
        Pop-Location
        # 7z a mvmf6.7z .\mvmf6\

    - name: Upload Artifact
      uses: actions/upload-artifact@v2
      with:
        path: mvmf6
