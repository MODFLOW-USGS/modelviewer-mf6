name: build-vtk

on:
  push:
    branches:
      - main
      - main-cmake

env:
  VTK_VERSION: 6.3.0

jobs:

  cache-vtk-debug:

    runs-on: windows-2016
    env:
      type: debug
      zipfile: v${{env.VTK_VERSION}}.zip
      instdir: C:/VTK-${{env.VTK_VERSION}}-vs2017-x64
      builddir: C:/VTK-${{env.VTK_VERSION}}-vs2017-x64-build
      srcdir: C:/VTK-${{env.VTK_VERSION}}

    steps:
      - uses: actions/checkout@v2

      - name: Cache vtk
        id: cache-vtk-debug
        uses: actions/cache@v2
        with:
          path: ${{env.instdir}}
          key: ${{runner.os}}-vtk-${{env.type}}-${{hashFiles('.github/workflows/build-vtk.yml', 'misc/CMakePresets.json')}}

      - name: Download vtk
        if: steps.cache-vtk-debug.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          curl -L -O "https://github.com/Kitware/VTK/archive/refs/tags/${{env.zipfile}}"
          Get-FileHash ${{env.zipfile}}
          cd C:\
          7z x ${{github.workspace}}\${{env.zipfile}}
          rm ${{github.workspace}}\${{env.zipfile}}

      - name: Build vtk
        if: steps.cache-vtk-debug.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          cp misc\CMakePresets.json ${{env.srcdir}}
          cd ${{env.srcdir}}
          echo cmake --preset vs2017
          echo cmake --build --preset vs2017 --config ${{env.type}}
          echo cmake --install ${{env.builddir}} --prefix ${{env.instdir}} --config ${{env.type}}
          mkdir ${{env.instdir}}
          mkdir ${{env.instdir}}\bin
          cmake -E touch ${{env.instdir}}\bin\vtkalglib-6.3d.dll
          mkdir ${{env.instdir}}\include
          mkdir ${{env.instdir}}\include\vtk-6.3
          cp "C:\VTK-6.3.0\Rendering\Core\vtkActor.h" "${{env.instdir}}\include"

  cache-vtk-release:

    runs-on: windows-2016
    env:
      type: release
      zipfile: v${{env.VTK_VERSION}}.zip
      instdir: C:/VTK-${{env.VTK_VERSION}}-vs2017-x64
      builddir: C:/VTK-${{env.VTK_VERSION}}-vs2017-x64-build
      srcdir: C:/VTK-${{env.VTK_VERSION}}

    steps:
      - uses: actions/checkout@v2

      - name: Cache vtk
        id: cache-vtk-release
        uses: actions/cache@v2
        with:
          path: ${{env.instdir}}
          key: ${{runner.os}}-vtk-${{env.type}}-${{hashFiles('.github/workflows/build-vtk.yml', 'misc/CMakePresets.json')}}

      - name: Download vtk
        if: steps.cache-vtk-release.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          curl -L -O "https://github.com/Kitware/VTK/archive/refs/tags/${{env.zipfile}}"
          Get-FileHash ${{env.zipfile}}
          cd C:\
          7z x ${{github.workspace}}\${{env.zipfile}}
          rm ${{github.workspace}}\${{env.zipfile}}

      - name: Build vtk
        if: steps.cache-vtk-release.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          cp misc\CMakePresets.json ${{env.srcdir}}
          cd ${{env.srcdir}}
          echo cmake --preset vs2017
          echo cmake --build --preset vs2017 --config ${{env.type}}
          echo cmake --install ${{env.builddir}} --prefix ${{env.instdir}} --config ${{env.type}}
          mkdir ${{env.instdir}}
          mkdir ${{env.instdir}}\bin
          cmake -E touch ${{env.instdir}}\bin\vtkalglib-6.3.dll
          mkdir ${{env.instdir}}\include
          mkdir ${{env.instdir}}\include\vtk-6.3
          cp "C:\VTK-6.3.0\Rendering\Core\vtkActor.h" "${{env.instdir}}\include"

  cache-vtk:
    runs-on: windows-2019
    needs: [cache-vtk-release, cache-vtk-release]

    steps:

      - name: Checkout
        uses: actions/checkout@v2

      - name: Cache vtk
        id: cache-vtk
        uses: actions/cache@v2
        with:
          path: ${{env.instdir}}
          key: ${{runner.os}}-vtk-${{hashFiles('.github/workflows/build-vtk.yml, misc/CMakePresets.json')}}

      - name: Cache vtk debug
        if: steps.cache-vtk.outputs.cache-hit != 'true'
        id: cache-vtk-debug
        uses: actions/cache@v2
        with:
          path: ${{env.instdir}}
          key: ${{runner.os}}-vtk-debug-${{hashFiles('.github/workflows/build-vtk.yml, misc/CMakePresets.json')}}

      - name: Cache vtk release
        if: steps.cache-vtk.outputs.cache-hit != 'true'
        uses: actions/cache@v2
        with:
          path: ${{env.instdir}}
          key: ${{runner.os}}-vtk-release-${{hashFiles('.github/workflows/build-vtk.yml', 'misc/CMakePresets.json')}}

      - name: Check cache
        shell: pwsh
        run: |
          dir c:\vtk-6.3.0-vs2017-x64
          dir c:\vtk-6.3.0-vs2017-x64\bin
          dir c:\vtk-6.3.0-vs2017-x64\include
